<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>iPhone Run + Aim + Jump + Sit</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 16px; }
    button { font-size: 18px; padding: 12px 16px; }
    .box { margin-top: 12px; padding: 12px; border: 1px solid #ddd; border-radius: 10px; }
    .row { display:flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f2f2f2; }
    .row:last-child { border-bottom: none; }
    .k { color: #444; }
    .v { font-variant-numeric: tabular-nums; font-weight: 700; }
    .ok { color: #0a7; font-weight: 900; }
    .bad { color: #c20; font-weight: 900; }
    .mid { color: #b60; font-weight: 900; }
    small { color: #666; }
    .pill {
      display:inline-block; padding: 6px 10px; border-radius: 999px;
      border: 1px solid #eee; background:#fafafa; font-weight:800;
    }
  </style>
</head>
<body>
  <h2>Run + Aim + Jump + Sit Detector</h2>
  <p><small>
    Tap enable. Aim by rotating phone. Running: step/bounce in place (best: phone in pocket).
    Jump: do a small jump while holding phone (or in pocket). Double-tap anywhere to re-calibrate aim.
  </small></p>

  <button id="btn">Tap to Enable Motion</button>

  <div class="box">
    <div>Status: <span id="status" class="bad">Not started</span></div>
    <div><small>If values don’t change, open in Safari and allow Motion & Orientation access.</small></div>
  </div>

  <div class="box">
    <h3>Aim / Direction</h3>
    <div class="row"><div class="k">Compass (alpha)</div><div class="v" id="compass">—</div></div>
    <div class="row"><div class="k">Compass label</div><div class="v" id="compassLabel">—</div></div>
    <div class="row"><div class="k">Yaw (relative)</div><div class="v" id="yaw">—</div></div>
    <div class="row"><div class="k">Pitch (relative)</div><div class="v" id="pitch">—</div></div>
    <div class="row"><div class="k">Aim label</div><div class="v" id="aimLabel">—</div></div>
  </div>

  <div class="box">
    <h3>Movement</h3>
    <div class="row"><div class="k">Move state</div><div class="v" id="moveState">—</div></div>
    <div class="row"><div class="k">Step rate (steps/s)</div><div class="v" id="stepRate">—</div></div>
    <div class="row"><div class="k">Last step (ms ago)</div><div class="v" id="lastStepAgo">—</div></div>
  </div>

  <div class="box">
    <h3>Actions / Pose</h3>
    <div class="row"><div class="k">Jump</div><div class="v" id="jumpState"><span class="pill">—</span></div></div>
    <div class="row"><div class="k">Pose</div><div class="v" id="poseState"><span class="pill">—</span></div></div>
  </div>

  <div class="box">
    <h3>Raw (for tuning)</h3>
    <div class="row"><div class="k">accMag</div><div class="v" id="accMag">—</div></div>
    <div class="row"><div class="k">accLP</div><div class="v" id="accLP">—</div></div>
    <div class="row"><div class="k">accHP</div><div class="v" id="accHP">—</div></div>
    <div><small>
      If running/jump is wrong, we tune thresholds: STEP_THRESHOLD, JUMP_SPIKE, etc.
    </small></div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);
  const fmt = (n, d=2) => (typeof n === "number" && isFinite(n) ? n.toFixed(d) : "—");

  function setStatus(ok, msg) {
    const el = $("status");
    el.textContent = msg;
    el.className = ok ? "ok" : "bad";
  }

  // ====== CONFIG (tune these) ======
  // Step detection (running)
  const STEP_THRESHOLD = 1.6;      // accHP peak threshold for a step
  const MIN_STEP_MS = 180;         // debounce (ms)
  const STOP_TIMEOUT_MS = 900;     // no step for this long => STOPPED
  const RUN_RATE_THRESHOLD = 2.2;  // steps/sec => RUNNING

  // Filters
  const LP_ALPHA = 0.90;           // low-pass smooth (0.85-0.95)

  // Jump detection (heuristic):
  // Trigger jump if we see a large positive spike, then (optional) a short low-magnitude phase.
  const JUMP_SPIKE = 5.5;          // accHP spike threshold
  const JUMP_COOLDOWN_MS = 900;    // prevent multiple jumps from one motion
  const JUMP_FLASH_MS = 700;       // show "JUMP!" this long

  // Sitting/standing (heuristic):
  // We treat "SITTING" if pitch absolute (beta) stays in a "tilted" range for a bit.
  // If phone is in pocket, beta often becomes more stable; tune for your carry style.
  const SIT_PITCH_DEG = 55;        // |beta| above this suggests seated/leaned pose
  const SIT_HOLD_MS = 900;         // must hold that long to mark SITTING
  const POSE_STABLE_DELTA = 6;     // beta variation allowed during hold

  // ====== Helpers ======
  function wrapDeg(x) {
    x = ((x + 180) % 360 + 360) % 360 - 180;
    return x;
  }

  function compassLabel(alphaDeg) {
    // 8-direction
    const dirs = ["N","NE","E","SE","S","SW","W","NW"];
    const idx = Math.round(alphaDeg / 45) % 8;
    return dirs[idx];
  }

  function aimLabel(yawDeg, pitchDeg) {
    const lr = yawDeg > 10 ? "Right" : yawDeg < -10 ? "Left" : "Center";
    const ud = pitchDeg > 10 ? "Down" : pitchDeg < -10 ? "Up" : "Level";
    return `${ud} + ${lr}`;
  }

  function pill(text, cls) {
    return `<span class="pill ${cls||""}">${text}</span>`;
  }

  // ====== State ======
  let started = false;

  // Aim calibration offsets
  let yaw0 = null;
  let pitch0 = null;

  // Orientation values
  let alphaAbs = null; // 0..360
  let betaAbs = null;  // -180..180

  // Step detection state
  let accLP = 0;
  let lastStepTs = 0;
  let lastPeakTs = 0;
  const stepTimes = [];

  // Jump detection state
  let lastJumpTs = 0;
  let jumpFlashUntil = 0;

  // Sit detection state
  let sitCandidateStart = 0;
  let sitCandidateBeta0 = 0;
  let pose = "—";

  function nowMs() { return performance.now(); }

  function updateStepRate(t) {
    while (stepTimes.length && (t - stepTimes[0]) > 2000) stepTimes.shift();
    return stepTimes.length / 2.0; // steps/sec over last 2s
  }

  function movementState(t, rate) {
    const since = t - lastStepTs;
    if (!lastStepTs || since > STOP_TIMEOUT_MS) return "STOPPED";
    if (rate >= RUN_RATE_THRESHOLD) return "RUNNING";
    return "MOVING";
  }

  function setMoveStateUI(state) {
    const el = $("moveState");
    el.textContent = state;
    el.className = state === "RUNNING" ? "ok" : (state === "STOPPED" ? "bad" : "mid");
  }

  function setJumpUI(isJumping) {
    $("jumpState").innerHTML = isJumping ? pill("JUMP!", "ok") : pill("—", "");
  }

  function setPoseUI(p) {
    // p in {"SITTING","STANDING","—"}
    let cls = "";
    if (p === "SITTING") cls = "mid";
    if (p === "STANDING") cls = "ok";
    $("poseState").innerHTML = pill(p, cls);
  }

  // ====== Permission & start ======
  async function requestIOSPermissionIfNeeded() {
    const DME = window.DeviceMotionEvent;
    const DOE = window.DeviceOrientationEvent;

    try {
      if (DME && typeof DME.requestPermission === "function") {
        const res = await DME.requestPermission();
        if (res !== "granted") throw new Error("DeviceMotion denied");
      }
      if (DOE && typeof DOE.requestPermission === "function") {
        const res = await DOE.requestPermission();
        if (res !== "granted") throw new Error("DeviceOrientation denied");
      }
      return true;
    } catch (e) {
      console.error(e);
      setStatus(false, "Permission denied ❌");
      return false;
    }
  }

  function startListeners() {
    if (started) return;
    started = true;
    setStatus(true, "Sensors active ✅");

    // Orientation -> aim + compass
    window.addEventListener("deviceorientation", (e) => {
      const alpha = e.alpha;
      const beta  = e.beta;
      if (typeof alpha !== "number" || typeof beta !== "number") return;

      alphaAbs = (alpha + 360) % 360;
      betaAbs = beta;

      // Compass display (absolute)
      $("compass").textContent = fmt(alphaAbs, 1) + "°";
      $("compassLabel").textContent = compassLabel(alphaAbs);

      // Calibrate relative aim offsets
      if (yaw0 === null) yaw0 = alphaAbs;
      if (pitch0 === null) pitch0 = betaAbs;

      const yaw = wrapDeg(alphaAbs - yaw0);
      const pitch = wrapDeg(betaAbs - pitch0);

      $("yaw").textContent = fmt(yaw, 1) + "°";
      $("pitch").textContent = fmt(pitch, 1) + "°";
      $("aimLabel").textContent = aimLabel(yaw, pitch);

      // Pose detection based on ABS beta (not relative)
      const t = nowMs();
      const b = betaAbs;

      if (Math.abs(b) >= SIT_PITCH_DEG) {
        if (!sitCandidateStart) {
          sitCandidateStart = t;
          sitCandidateBeta0 = b;
        } else {
          const held = (t - sitCandidateStart);
          const stable = Math.abs(b - sitCandidateBeta0) <= POSE_STABLE_DELTA;
          if (held >= SIT_HOLD_MS && stable) pose = "SITTING";
        }
      } else {
        // If not in sit range, reset candidate and mark standing
        sitCandidateStart = 0;
        pose = "STANDING";
      }
      setPoseUI(pose);

    }, true);

    // Motion -> running + jump
    window.addEventListener("devicemotion", (e) => {
      const a = e.acceleration;
      const ag = e.accelerationIncludingGravity;
      const src = (a && typeof a.x === "number") ? a : ag;
      if (!src) return;

      const ax = src.x || 0, ay = src.y || 0, az = src.z || 0;
      const mag = Math.sqrt(ax*ax + ay*ay + az*az);

      accLP = LP_ALPHA * accLP + (1 - LP_ALPHA) * mag;
      const accHP = mag - accLP;

      $("accMag").textContent = fmt(mag, 3);
      $("accLP").textContent = fmt(accLP, 3);
      $("accHP").textContent = fmt(accHP, 3);

      const t = nowMs();

      // Step detection: positive peaks over threshold
      if (accHP > STEP_THRESHOLD && (t - lastPeakTs) > MIN_STEP_MS) {
        lastPeakTs = t;
        lastStepTs = t;
        stepTimes.push(t);
      }

      const rate = updateStepRate(t);
      $("stepRate").textContent = fmt(rate, 2);
      const state = movementState(t, rate);
      setMoveStateUI(state);

      const ago = lastStepTs ? (t - lastStepTs) : NaN;
      $("lastStepAgo").textContent = lastStepTs ? fmt(ago, 0) : "—";

      // Jump detection (heuristic)
      const canJump = (t - lastJumpTs) > JUMP_COOLDOWN_MS;
      if (canJump && accHP > JUMP_SPIKE) {
        lastJumpTs = t;
        jumpFlashUntil = t + JUMP_FLASH_MS;
      }

      setJumpUI(t < jumpFlashUntil);

    }, true);

    // Double tap anywhere to recalibrate aim center
    document.body.addEventListener("dblclick", () => {
      yaw0 = null;
      pitch0 = null;
    });
  }

  $("btn").addEventListener("click", async () => {
    setStatus(false, "Requesting permission…");
    const ok = await requestIOSPermissionIfNeeded();
    if (ok) startListeners();
  });
</script>
</body>
</html>